var builtinComponents=[{name:"Effect List",code:4294967294,group:"",func:"effectList"},{name:"FadeOut",code:3,group:"Trans",func:"generic",fields:{speed:sizeInt,color:["Color",sizeInt]}},{name:"Blitter Feedback",code:4,group:"Misc",func:"generic",fields:{zoom:sizeInt,onBeatZoom:sizeInt,output:["Map4",{0:"Replace",1:"50/50"}],onBeat:["Bool",sizeInt],bilinear:["Bool",sizeInt]}},{name:"Blur",code:6,group:"Trans",func:"generic",fields:{blur:["Map4",{0:"None",1:"Medium",2:"Light",3:"Heavy"}],round:["Map4",{0:"Down",1:"Up"}]}},{name:"Buffer Save",code:18,group:"Misc",func:"generic",fields:{mode:["BufferMode",sizeInt],buffer:["BufferNum",sizeInt],blend:["BlendmodeBuffer",sizeInt],adjustBlend:sizeInt}},{name:"Water",code:20,group:"Trans",func:"generic",fields:{enabled:["Bool",sizeInt]}},{name:"Comment",code:21,group:"Misc",func:"generic",fields:{text:"SizeString"}},{name:"Grain",code:24,group:"Trans",func:"generic",fields:{enabled:["Bool",sizeInt],output:["Map8",{0:"Replace",1:"Additive",4294967296:"50/50"}],amount:sizeInt,"static":["Bool",sizeInt]}},{name:"Bump",code:29,group:"Trans",func:"generic",fields:{enabled:["Bool",sizeInt],onBeat:["Bool",sizeInt],duration:sizeInt,depth:sizeInt,onBeatDepth:sizeInt,output:["Map8",{0:"Replace",1:"Additive",4294967296:"50/50"}],code:"CodeFBI",showDot:["Bool",sizeInt],invertDepth:["Bool",sizeInt],null0:sizeInt,depthBuffer:["BufferNum",sizeInt]}},{name:"Invert",code:37,group:"Trans",func:"generic",fields:{enabled:["Bool",sizeInt]}},{name:"Super Scope",code:36,group:"Render",func:"generic",fields:{enabled:["Bool",1],code:"CodePFBI",audioChannel:["Bit",[0,1],"AudioChannel"],audioRepresent:["Bit",2,"AudioRepresent"],null0:3,colors:"ColorList",lineType:["DrawMode",sizeInt]}},{name:"Set Render Mode",code:40,group:"Misc",func:"generic",fields:{blend:["BlendmodeRender",1],adjustBlend:1,lineSize:1,enabled:["Bit",7,"Boolified"]}},{name:"Dynamic Movement",code:43,group:"Trans",func:"generic",fields:{enabled:["Bool",1],code:"CodePFBI",bilinear:["Bool",sizeInt],coordinates:["Coordinates",sizeInt],gridW:sizeInt,gridH:sizeInt,alpha:["Bool",sizeInt],wrap:["Bool",sizeInt],buffer:["BufferNum",sizeInt],alphaOnly:["Bool",sizeInt]}},{name:"Fast Brightness",code:44,group:"Trans",func:"generic",fields:{factor:["Map4",{0:2,1:0.5,2:1}]}},{name:"Color Modifier",code:45,group:"Trans",func:"generic",fields:{recomputeEveryFrame:["Bool",1],code:"CodePFBI"}}];var dllComponents=[{name:"AVS Trans Automation",code:[77,105,115,99,58,32,65,86,83,84,114,97,110,115,32,65,117,116,111,109,97,116,105,111,110,0,0,0,0,0,0,0],group:"Misc",func:"generic",fields:{enabled:["Bool",sizeInt],logging:["Bool",sizeInt],translateFirstLevel:["Bool",sizeInt],readCommentCodes:["Bool",sizeInt],code:"NtString"}},{name:"Texer II",code:[65,99,107,111,46,110,101,116,58,32,84,101,120,101,114,32,73,73,0,0,0,0,0,0,0,0,0,0,0,0,0,0],group:"Render",func:"generic",fields:{null0:sizeInt,image:["SizeString",260],resizing:["Bool",sizeInt],wrap:["Bool",sizeInt],coloring:["Bool",sizeInt],null1:sizeInt,code:"CodeIFBP"}},{name:"Color Map",code:[67,111,108,111,114,32,77,97,112,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],group:"Trans",func:"colorMap",fields:{key:["KeyColorMap",sizeInt],maps:"ColorMaps",output:["BufferModeColorMap",sizeInt],mapCycling:["CycleModeColorMap",sizeInt],cycleSpeed:sizeInt,dontSkipFastBeats:["Bool",sizeInt]}},{name:"Framerate Limiter",code:[86,70,88,32,70,82,65,77,69,82,65,84,69,32,76,73,77,73,84,69,82,0,0,0,0,0,0,0,0,0,0,0],group:"Misc",func:"generic",fields:{enabled:["Bool",sizeInt],limit:sizeInt}},{name:"Convolution Filter",code:[72,111,108,100,101,110,48,51,58,32,67,111,110,118,111,108,117,116,105,111,110,32,70,105,108,116,101,114,0,0,0,0],group:"Misc",func:"generic",fields:{enabled:["Bool",sizeInt],wrap:["Bool",sizeInt],absolute:["Bool",sizeInt],"2-pass":["Bool",sizeInt],kernel:["ConvoFilter",[7,7]],bias:["Bool",sizeInt],scaling:["Bool",sizeInt]}},{name:"Triangle",code:[82,101,110,100,101,114,58,32,84,114,105,97,110,103,108,101,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],group:"Misc",func:"generic",fields:{code:"CodeIFBP"}},{name:"Channel Shift",code:[67,104,97,110,110,101,108,32,83,104,105,102,116,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],group:"Misc",func:"generic",fields:{mode:["Map4",{1144:"RGB",1020:"RBG",1019:"BRG",1021:"BGR",1018:"GBR",1022:"GRB"}],onBeatRandom:["Bool",sizeInt]}},{name:"Normalize",code:[84,114,97,110,115,58,32,78,111,114,109,97,108,105,115,101,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],group:"Trans",func:"generic",fields:{enabled:["Bool",sizeInt]}},{name:"MIDI Trace",code:[78,117,108,108,115,111,102,116,32,80,105,120,101,108,99,111,114,112,115,58,32,77,73,68,73,116,114,97,99,101,32,0],group:"Misc",func:"generic",fields:{enabled:["Bool",sizeInt],channels:sizeInt,mode:["Map32",{1:"Current",2:"Trigger"}],allChannels:["Bool",sizeInt],printEvents:["Bool",sizeInt]}}];var componentTable=builtinComponents.concat(dllComponents);function convertPreset(f){var d={};var b=new Uint8Array(f);try{var a=decodePresetHeader(b.subarray(0,presetHeaderLength));d.clearFrame=a;var c=convertComponents(b.subarray(presetHeaderLength));d.components=c}catch(g){if(g instanceof ConvertException){log("Error: "+g.message);return null}else{throw g}}return d}function convertComponents(a){var h=0;var f=[];while(h<a.length){var b=getUInt32(a,h);var e=getComponentIndex(b,a,h);var d=b>builtinMax&&b!==4294967294;var j=getComponentSize(a,h+sizeInt+d*32);if(e<0){var g={type:"Unknown: ("+(-e)+")"}}else{var c=h+sizeInt*2+d*32;var g=window["decode_"+componentTable[e].func](a,c,componentTable[e].fields,componentTable[e].name,c+j)}if(!g||typeof g!=="object"){throw new ConvertException("Unknown convert error")}f.push(g);h+=j+sizeInt*2+d*32}return f}function getComponentIndex(c,a,d){if(c<builtinMax||c===4294967294){for(var b=0;b<componentTable.length;b++){if(c===componentTable[b].code){log("Found component: "+componentTable[b].name+" ("+c+")");return b}}}else{for(var b=builtinComponents.length;b<componentTable.length;b++){if(componentTable[b].code instanceof Array&&cmpBytes(a,d+sizeInt,componentTable[b].code)){log("Found component: "+componentTable[b].name);return b}}}log("Found unknown component (code: "+c+")");return -c}function getComponentSize(a,b){return getUInt32(a,b)}function decodePresetHeader(a){var b=[78,117,108,108,115,111,102,116,32,65,86,83,32,80,114,101,115,101,116,32,48,46,50,26];if(!cmpBytes(a,0,b)){throw new ConvertException("Invalid preset header.")}return a[presetHeaderLength-1]===1}function decode_effectList(a,e){var k=getUInt32(a,e-sizeInt);var g={type:"EffectList",enabled:getBit(a,e,1)[0]!==1,clearFrame:getBit(a,e,0)[0]===1,input:getBlendmodeIn(a,e+2,1)[0],output:getBlendmodeOut(a,e+3,1)[0],inAdjustBlend:getUInt32(a,e+5),outAdjustBlend:getUInt32(a,e+9),inBuffer:getUInt32(a,e+13),outBuffer:getUInt32(a,e+17),inBufferInvert:getUInt32(a,e+21)===1,outBufferInvert:getUInt32(a,e+25)===1,enableOnBeat:getUInt32(a,e+29)===1,onBeatFrames:getUInt32(a,e+33)};var b=[0,64,0,0,65,86,83,32,50,46,56,43,32,69,102,102,101,99,116,32,76,105,115,116,32,67,111,110,102,105,103,0,0,0,0,0];var i=e+37;var f=k-37;var c=i;if(cmpBytes(a,i,b)){i+=b.length;var j=getUInt32(a,i);c+=b.length+sizeInt+j;f=k-37-b.length-sizeInt-j;g.codeEnabled=getUInt32(a,i+sizeInt)===1;var d=getUInt32(a,i+sizeInt*2);g.init=getSizeString(a,i+sizeInt*2)[0];g.frame=getSizeString(a,i+sizeInt*3+d)[0]}var h=convertComponents(a.subarray(c,c+f));g.components=h;return g}function decode_generic(a,g,n,v,c){var t={type:removeSpaces(v)};var l=Object.keys(n);var u=false;for(var q=0;q<l.length;q++){if(g>=c){break}var p=l[q];var r=n[p];if(p.match(/^null[_0-9]*$/)){g+=r;u=false;continue}var m=0;var o,j;var b=typeof r==="number";var d=typeof r==="string";var h=r instanceof Array;if(b){switch(r){case 1:m=1;o=a[g];break;case sizeInt:m=sizeInt;o=getUInt32(a,g);break;default:throw new ConvertException("Invalid field size: "+r+".")}u=false}else{if(d){try{j=window["get"+r](a,g)}catch(s){if(s.message.search(/has no method'/)>=0){throw new ConvertException("Method '"+r+"' was not found. (correct capitalization?)")}else{throw s}}o=j[0];m=j[1];u=false}else{if(r&&r.length>=2){if(r[0]==="Bit"){if(u){g-=1}u=true}else{u=false}try{j=window["get"+r[0]](a,g,r[1]);o=j[0];if(r[2]){o=window["get"+r[2]](o)}}catch(s){if(s.message.search(/has no method/)>=0){throw new ConvertException("Method '"+r+"' was not found. (correct capitalization?)")}else{throw s}}m=j[1]}}}t[p]=o;g+=m}return t}function decode_colorMap(a,b){return{type:"ColorMap"}}function getMap1(a,c,b){return[getMapping(a,c,b,a[c]),1]}function getMap4(a,c,b){return[getMapping(a,c,b,getUInt32(a,c)),sizeInt]}function getMap8(a,c,b){return[getMapping(a,c,b,getUInt64(a,c)),sizeInt*2]}function getMapping(a,e,d,b){var c=d[b];if(c===undefined){throw new ConvertException("Map: A value for key '"+b+"' does not exist.")}else{return c}}function getCodePFBI(a,c){var b=[["init",3],["perFrame",1],["onBeat",2],["perPoint",0]];return getCodeSection(a,c,b)}function getCodeFBI(a,c){var b=[["init",2],["onBeat",0],["perFrame",1]];return getCodeSection(a,c,b)}function getCodeIFBP(a,c){var b=[["init",0],["perFrame",1],["onBeat",2],["perPoint",3]];return getCodeSection(a,c,b)}function getCodeSection(a,e,b){var j=new Array(b.length);var h=0;for(var f=0,d=e;f<b.length;f++,d+=g[1]){var g=getSizeString(a,d);h+=g[1];j[f]=g[0]}var c={};for(var f=0;f<j.length;f++){c[b[f][0]]=j[b[f][1]]}return[c,h]}function getColorList(b,e){var a=[];var c=getUInt32(b,e);var d=sizeInt+c*sizeInt;while(c>0){e+=sizeInt;a.push(getColor(b,e)[0]);c--}return[a,d]}function getColorMap(b,g){var d=getUInt32(b,g);var f=d;var c=[];g+=sizeInt;for(var e=0;e<d;e++){var h=getUInt32(b,g);var a=getColor(b,g+sizeInt);g+=sizeInt*2+sizeInt;c[e]={color:a,position:h}}return c}function getColor(b,e){var a=getUInt32(b,e).toString(16);var d="";for(var c=a.length;c<6;c++){d+="0"}return["#"+d+a,sizeInt]}function getConvoFilter(b,g,e){if(!(e instanceof Array)&&e.length!==2){throw new ConvertException("ConvoFilter: Size must be array with x and y dimensions in dwords.")}var d=e[0]*e[1];var f=new Array(d);for(var c=0;c<d;c++,g+=sizeInt){f[c]=getInt32(b,g)}var a={width:e[0],height:e[1],data:f};return[a,d*sizeInt]}function getBlendmodeIn(a,d,b){var c=b===1?a[d]:getUInt32(a,d);return[blendmodesIn[c],b]}function getBlendmodeOut(a,d,b){var c=b===1?a[d]:getUInt32(a,d);return[blendmodesOut[c],b]}function getBlendmodeBuffer(a,d,b){var c=b===1?a[d]:getUInt32(a,d);return[blendmodesBuffer[c],b]}function getBlendmodeRender(a,d,b){var c=b===1?a[d]:getUInt32(a,d);return[blendmodesRender[c],b]}function getBufferMode(a,d,b){var c=b===1?a[d]:getUInt32(a,d);return[buffermodes[c],b]}function getBufferNum(a,d,b){var c=b===1?a[d]:getUInt32(a,d);if(c===0){return["Current",b]}else{return[getUInt32(a,d),b]}}function getCoordinates(a,d,b){var c=b===1?a[d]:getUInt32(a,d);return[coordinates[c],b]}function getDrawMode(a,d,b){var c=b===1?a[d]:getUInt32(a,d);return drawModes[c]}function getAudioChannel(a){return audioChannels[a]}function getAudioRepresent(a){return audioRepresentations[a]}function checkCompat(){if(window.File&&window.FileReader&&window.FileList&&window.Blob){compat=true}else{compat=false}}function loadDir(c,e){var a=c.files;var d=[];for(var b=0;b<a.length;b++){if(e.test(a[b].name)){d.push(a[b])}}return d}function loadFile(b,c){if(!b instanceof File){log("Error: 'file' parameter is no file.");return false}if(typeof c!=="function"){log("Error: 'callback' parameter is no function.");return false}log("Loading file "+b.name+"... ");var a=new FileReader();a.onloadend=function(d){if(d.target.readyState==FileReader.DONE){c(d.target.result,b.name)}};a.readAsArrayBuffer(b)}var compat=false;var outputDir="";var pedanticMode=false;$(document).ready(function(){checkCompat();log("File API check: "+(compat?"success":"fail")+".");var a=[];$("#preset").change(function(){a=loadDir(this,/\.avs$/);log("Found "+a.length+" files in directory.");for(var b=0;b<a.length;b++){loadFile(a[b],saveAvsAsJson)}})});function saveAvsAsJson(d,b){var c={name:b.substr(0,b.length-4),author:"-",components:convertPreset(d)};var a=("#output");$(a).html(JSON.stringify(c,null,"    "));$(a).each(function(f,g){hljs.highlightBlock(g)})}function jsonPrintSpecials(b,a){if(b==="convolutionMatrix"){return a.join(",")}return a}var blendmodesIn={"0":"Ignore","1":"Replace","2":"50/50","3":"Maximum","4":"Additive","5":"Dest-Src","6":"Src-Dest","7":"EveryOtherLine","8":"EveryOtherPixel","9":"XOR","10":"Adjustable","11":"Multiply","12":"Buffer"};var blendmodesOut={"0":"Replace","1":"Ignore","2":"Maximum","3":"50/50","4":"Dest-Src","5":"Additive","6":"EveryOtherLine","7":"Src-Dest","8":"XOR","9":"EveryOtherPixel","10":"Multiply","11":"Adjustable","13":"Buffer"};var blendmodesBuffer={"0":"Replace","1":"50/50","2":"Additive","5":"EveryOtherPixel","4":"Dest-Src","5":"EveryOtherLine","6":"XOR","7":"Maximum","8":"Minimum","9":"Src-Dest","10":"Multiply","11":"Adjustable"};var blendmodesRender={"0":"Replace","1":"Additive","2":"Maximum","3":"50/50","4":"Dest-Src","5":"Src-Dest","6":"Multiply","7":"Adjustable","8":"XOR"};var blendmodesColorMap={"0":"Replace","1":"Additive","2":"Maximum","3":"50/50","4":"Dest-Src","5":"Src-Dest","6":"Multiply","7":"Adjustable","8":"XOR"};var buffermodes={"0":"Save","1":"Restore","2":"AlternateSaveRestore","3":"AlternateRestoreSave"};var coordinates={"0":"Polar","1":"Cartesian"};var drawModes={"0":"Dots","1":"Lines"};var audioChannels={"0":"Left","1":"Right","2":"Center"};var audioRepresentations={"0":"Waveform","1":"Spectrum"};var sizeInt=4;var presetHeaderLength=25;var builtinMax=16384;function log(a){$("#log").prepend(a+"\n")}function ConvertException(a){this.message=a;this.name="ConvertException"}function cmpBytes(a,c,d){for(var b=0;b<d.length;b++){if(d[b]===null){continue}if(a[b+c]!==d[b]){return false}}return true}function getBit(b,c,d){if(d instanceof Array){if(d.length!==2){new ConvertException("Wrong Bitfield range")}var a=(2<<(d[1]-d[0]))-1;return[(b[c]>>d[0])&a,1]}else{return[((b[c]>>d)&1),1]}}function getUInt32(a,b){if(!b){b=0}var c=a.buffer.slice(a.byteOffset+b,a.byteOffset+b+sizeInt);return new Uint32Array(c,0,1)[0]}function getInt32(a,b){if(!b){b=0}var c=a.buffer.slice(a.byteOffset+b,a.byteOffset+b+sizeInt);return new Int32Array(c,0,1)[0]}function getUInt64(b,c){if(!c){c=0}var d=b.buffer.slice(b.byteOffset+c,b.byteOffset+c+sizeInt*2);var a=new Uint32Array(d,0,2);return a[0]+a[1]*4294967296}function getBool(a,d,b){var c=b===1?a[d]:getUInt32(a,d);return[c!==0,b]}function getBoolified(a){return a==0?false:true}function getSizeString(d,h,f){var g=0;var a="";if(!f){f=getUInt32(d,h);g=sizeInt}var b=h+f+g;var e=h+g;var j=d[e];while(j>0&&e<b){a+=String.fromCharCode(j);j=d[++e]}return[a,f+g]}function getNtString(b,e){var a="";var d=e;var f=b[d];while(f>0){a+=String.fromCharCode(f);f=b[++d]}return[a,d-e]}function removeSpaces(a){return a.replace(/[ ]/g,"")};